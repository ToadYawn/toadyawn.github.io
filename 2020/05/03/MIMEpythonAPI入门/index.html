<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="null">
    <meta name="keyword"  content="null">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        MIMEpythonAPI入门 - ToadYawn的博客 | ToadYawn&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 汤圆 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Tingyu Hu</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#email-parser"><span class="toc-text">email.parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-feedparser"><span class="toc-text">email.feedparser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-message-py"><span class="toc-text">email.message.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#访问消息头接口"><span class="toc-text">访问消息头接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#头字段相关方法"><span class="toc-text">头字段相关方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询和处理消息的内容（有效负载）有关"><span class="toc-text">查询和处理消息的内容（有效负载）有关</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-generator-Generating-MIME-documents"><span class="toc-text">email.generator: Generating MIME documents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-policy-Policy-Objects"><span class="toc-text">email.policy: Policy Objects</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-headerregistry"><span class="toc-text">email.headerregistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#email-contentmanager"><span class="toc-text">email.contentmanager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-text">示例</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 汤圆 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        MIMEpythonAPI入门
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-05-03 18:18:09</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#python" title="python">python</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <p>email - 电子邮件与MIME处理包  </p>
<ol>
<li>三主要组件，加上控制组件行为的组件  </li>
</ol>
<p>在 message 模块定义 EmailMessage 对象模型 是 树形结构<br>组件：parser 将字节流变为 EmailMessage 对象<br>    generator 将 EmailMessage 对象变为字节流 虽然支持文本字符流但是不推荐<br>控制组件： policy 通常在创建对象/复制/解析时用到 可在generator时改变 从硬盘中一般解析，然后以标准SMTP设置序列化后发送到服务器  </p>
<p>email包本来对应用隐藏RFC定义的一些细节，视之为unicode文本和二进制附件的结构树email对象。但是实际上经常必须知道MIME的content type和定义multipart的方式  </p>
<ol start="2">
<li>异常处理和 headerregistry/contentmanger 子组件</li>
</ol>
<h2 id="email-parser"><a href="#email-parser" class="headerlink" title="email.parser"></a>email.parser</h2><p>email.parser.py<br>创建emailmeassage对象：1. 使用字典添加header,使用set_content()添加载荷<br>2.通过解析emailmessage成序列化表现形式  </p>
<p>传入字节/字符串/文件对象，返回emailmessage实例的根  </p>
<p>非MIME载荷的根对象是信息文本的字符串<br>MIME的根对象is_multipart()返回True，子部分用载荷操作方法比如get_body()iter_parts()和 walk()</p>
<p>两个接口Parser API：内存中有整个信息文本，或者存在于文件中<br>增量FeedParserAPI：流读取 存在阻断等待</p>
<p>通过实现Policy方法自定义版本来实现自己的解析器，连接EMAIL包和emailmessage类的逻辑  </p>
<ul>
<li>class Parser<br>_class<br>policy<br>parse(self,fp,headersonly=False)<br>  调用FeedParser<br>  while True<br>  data = fp.read(8192)<br>  feedparser.feed(data)</li>
</ul>
<p>parsestr(self, text, headersonly=False)<br>    调用parse(StringIO(text))</p>
<ul>
<li>class HeaderParser(Parser)<br>parse(self, fp, headersonly=True)<br>  return Parser.parse(self, fp, True)</li>
</ul>
<p>parsestr(self, text, headersonly=True)<br>    return Parser.parsestr(self, text, True)</p>
<ul>
<li>class BytesParser<br>parser = Parser(*args, **kw)</li>
</ul>
<p>parse(self, fp, headersonly=False)<br>    fp = TextIOWrapper(fp, encoding=’ascii’, errors=’surrogateescape’)<br>    TextIOWrapper将字符串转化为流<br>    StringIO将得到内存流<br>    return self.parser.parse(fp, headersonly)</p>
<p>parsebytes(self, text, headersonly=False)<br>    text = text.decode(‘ASCII’, errors=’surrogateescape’)<br>    return self.parser.parsestr(text, headersonly)</p>
<h2 id="email-feedparser"><a href="#email-feedparser" class="headerlink" title="email.feedparser"></a>email.feedparser</h2><ul>
<li>class BufferedSubFile 略过<br>push_eof_matcher(self, pred):<br>  self._eofstack.append(pred)</li>
</ul>
<p>def pop_eof_matcher(self):<br>    return self._eofstack.pop()</p>
<p>def readline(self)<br>    return line</p>
<p>def push(self, data):<br>    “””Push some new data into this object.”””<br>    self._partial.write(data)<br>    if ‘\n’ not in data and ‘\r’ not in data:</p>
<pre><code>    # No new complete lines, wait for more.
    return

# Crack into lines, preserving the linesep characters.
self._partial.seek(0)
parts = self._partial.readlines()
self._partial.seek(0)
self._partial.truncate()

# If the last element of the list does not end in a newline, then treat
# it as a partial line.  We only check for &apos;\n&apos; here because a line
# ending with &apos;\r&apos; might be a line that was split in the middle of a
# &apos;\r\n&apos; sequence (see bugs 1555570 and 1721862).
if not parts[-1].endswith(&apos;\n&apos;):
    self._partial.write(parts.pop())
self.pushlines(parts)
</code></pre><ul>
<li>class FeedParser<br>def feed(self, data)<br>  self._input.push(data)</li>
</ul>
<p>def _parsegen(self)<br>    headers = []<br>    boundary<br>    lines</p>
<p>def _parse_headers(self, lines)</p>
<ul>
<li>BytesFeedParser</li>
</ul>
<p>def feed(self, data):<br>    super().feed(data.decode(‘ascii’, ‘surrogateescape’)<br>    将bytes解码后feed</p>
<h2 id="email-message-py"><a href="#email-message-py" class="headerlink" title="email.message.py"></a>email.message.py</h2><ul>
<li><p>class Message<br>  def as_string(self, unixfrom=False, maxheaderlen=0, policy=None):</p>
<p>  def attach(self, payload):</p>
<p>  def get(self, name, failobj=None):</p>
<pre><code>&quot;&quot;&quot;Get a header value.

Like __getitem__() but return failobj instead of None when the field
is missing.
&quot;&quot;&quot;
name = name.lower()
for k, v in self._headers:
    if k.lower() == name:
        return self.policy.header_fetch_parse(k, v)
return failobj
</code></pre><p>  def get_payload(self, i=None, decode=False):</p>
<pre><code>会按照 已decode，直接返回，未decode，按照cte种类
        cte == &apos;quoted-printable&apos;
        cte == &apos;base64&apos;
        cte in (&apos;x-uuencode&apos;, &apos;uuencode&apos;, &apos;uue&apos;, &apos;x-uue&apos;)
</code></pre><p>  def set_payload(self, payload, charset=None):</p>
<p>  def set_charset(self, charset):</p>
<p>  def get_charset(self):<br>  def get_content_charset(self, failobj=None):</p>
<p>  def get_content_type(self):</p>
<p>  def get_content_maintype(self):</p>
<p>  def get_content_subtype(self):</p>
<p>  def get_params(self, failobj=None, header=’content-type’, unquote=True):返回内容类型的列表</p>
<pre><code>missing = object()
params = self._get_params_preserve(missing, header)
if params is missing:
    return failobj
if unquote:
    return [(k, _unquotevalue(v)) for k, v in params]
else:
    return params
</code></pre><p>  def get_param(self, param, failobj=None, header=’content-type’,unquote=True):</p>
<pre><code>if header not in self:
    return failobj
for k, v in self._get_params_preserve(failobj, header):
    if k.lower() == param.lower():
        if unquote:
            return _unquotevalue(v)
        else:
            return v
return failobj
</code></pre></li>
</ul>
<pre><code>def get_filename(self, failobj=None):从Content-Disposition中得到
    missing = object()
    filename = self.get_param(&apos;filename&apos;, missing, &apos;content-disposition&apos;)
    if filename is missing:
        filename = self.get_param(&apos;name&apos;, missing, &apos;content-type&apos;)
    if filename is missing:
        return failobj
    return utils.collapse_rfc2231_value(filename).strip()

def get_boundary(self, failobj=None):
    missing = object()
    boundary = self.get_param(&apos;boundary&apos;, missing)
    if boundary is missing:
        return failobj
    return utils.collapse_rfc2231_value(boundary).rstrip()

def get_content_disposition(self):返回&apos;inline&apos;或者&apos;attachment&apos;，None
</code></pre><ul>
<li>email.message_from_bytes(s, _class=None, <em>, policy=policy.compat32)<br>类字节对象返回消息对象结构。等同于BytesParser().parsebytes(s)。可选的_class和 policy与BytesParser类构造函数一样解释。<br>email.message_from_binary_file(fp, _class=None, </em>, policy=policy.compat32)<br>email.message_from_string(s, _class=None, <em>, policy=policy.compat32)<br>email.message_from_file(fp, _class=None, </em>, policy=policy.compat32)  </li>
</ul>
<p>大多数非多部分类型的消息都被解析为带有字符串有效负载的单个消息对象。这些对象将is_multipart()返回False，并且 iter_parts()将产生一个空列表<br>所有multipart的消息都将被解析为容器消息对象，并带有其有效负载的子消息对象列表<br>message / *的消息（例如 message / delivery-status和message / rfc822）也将被解析为包含长度为1的列表有效负载的容器对象  </p>
<ul>
<li>EmailMessage 继承MIMEPart<br>电子邮件包含标题和有效负载（也称为content）。标头是RFC 5322或RFC 6532样式字段名称和值<br>有效负载可以是简单的文本消息，也可以是二进制对象，也可以是子消息的结构化序列，每个子消息都具有自己的标头集和自己的有效负载。有效负载的后一种类型由具有MIME类型的消息（例如 multipart / *或 message / rfc822）指示<br>与实际字典不同的是，这些键有一个排序，并且可以有重复的键  </li>
</ul>
<p>class email.message.EmailMessage(policy=default)<br>代替RFC强制\r\n使用，它使用Python标准\n行尾<br>as_string(unixfrom=False, maxheaderlen=None, policy=None)返回整平为字符串的整个消息。当可选的 unixfrom为true时，信封头包含在返回的字符串中，指定的策略将传递给Generator “7 bit clean” when utf8 is False<br>__str__() 与as_string等同 utf8=True<br>as_bytes(unixfrom=False, policy=None)返回展平为字节对象的整个消息BytesGenerator<br>__bytes__()等同于as_bytes()<br>is_multipart()若消息负载是子消息对象的列表则返回True 返回True并不一定意味着“ msg.get_content_maintype（）==’multipart’”将返回True 例如EmailMessage 是 message/rfc822类型，is_multipart会返回True<br>set_unixfrom(unixfrom)将邮件的信封标头设置为unixfrom，它应该是一个字符串<br>get_unixfrom()返回邮件的信封头  </p>
<h3 id="访问消息头接口"><a href="#访问消息头接口" class="headerlink" title="访问消息头接口"></a>访问消息头接口</h3><p>__len__()返回头总数，包括重复项<br>__contains__(name)True如果消息对象具有名为name的字段。用于in例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">'message-id'</span> <span class="keyword">in</span> myMessage:</span><br><span class="line">print(<span class="string">'Message-ID:'</span>, myMessage[<span class="string">'message-id'</span>])</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">\_\_getitem\_\_(name) 返回头字段的值 若没有则返回<span class="keyword">None</span>,若由多个字段则使用get_all()  </span><br><span class="line">\_\_setitem\_\_(name, val)向消息添加标头，其字段名称为name，值为val。该字段将附加到邮件现有标题的末尾。不能覆盖或删除任何现有的头名称相同。如果要确保新标题是消息中字段名称为name的唯一标题，请首先删除该字段，例如：  </span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"><span class="keyword">del</span> msg[<span class="string">'subject'</span>]</span><br><span class="line">msg[<span class="string">'subject'</span>] = <span class="string">'Python roolz!'</span></span><br></pre></td></tr></table></figure></p>
<p>__delitem__(name)从邮件标题中删除所有出现的名称为name的字段。如果标题字段中不存在命名字段，则不会引发异常。<br>keys()返回所有消息标题字段名称的列表。<br>values()返回所有消息字段值的列表<br>items()返回一个包含所有消息字段标题和值的2元组列表<br>get(name, failobj=None)与<strong>getitem</strong>等同，可选failobj在没有头字段时会返回  </p>
<h3 id="头字段相关方法"><a href="#头字段相关方法" class="headerlink" title="头字段相关方法"></a>头字段相关方法</h3><ul>
<li><p>get_all(name, failobj=None)<br>返回名为name的字段的所有值的列表。如果消息中没有这样的命名头，则返回failobj（默认为 None）  </p>
</li>
<li><p>add_header(_name, _value, **<em>params)<br>与\</em>_setitem__() 类似_params是字典类型key=”value”，下划线转化为破折号(python中破折号非法) 值包含非ASCII字符，则可以通过将值指定为三个元组来显式地控制字符集和语言例如  (CHARSET, LANGUAGE, VALUE)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msg.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">'bud.gif'</span>)</span><br><span class="line">msg.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>,</span><br><span class="line">            filename=(<span class="string">'iso-8859-1'</span>, <span class="string">''</span>, <span class="string">'Fußballer.ppt'</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>replace_header(_name, _value)<br>替换在消息中找到的与_name匹配的第一个标头找不到匹配的头，引发 KeyError.  </p>
</li>
<li>get_content_type()<br>返回消息的内容类型，强制为小写形式 maintype / subtype。如果 消息中没有Content-Type头，则返回的值 get_default_type()。如果Content-Type标头无效，则返回text/plain<br>get_default_type()大多数消息的默认内容类型为text / plain，多部分/摘要容器的子部分的消息是message / rfc822  </li>
<li>get_content_maintype()  </li>
<li><p>get_content_subtype()  </p>
</li>
<li><p>set_param(param, value, header=’Content-Type’, requote=True, charset=None, language=’’, replace=False)<br>将content-type设置param  </p>
</li>
<li><p>del_param(param, header=’content-type’, requote=True)  </p>
</li>
<li><p>get_filename(failobj=None)<br>得到Content-Disposition中filename的值，若没找到则找Content-Type中的name，都找不到 字符串将去掉引号  </p>
</li>
<li>get_boundary(failobj=None)<br>返回消息的Content-Type标头的boundary值 字符串将去掉引号  </li>
<li>get_content_charset(failobj=None)<br>返回消息的Content-Type标头的charset值强制转换为小写  </li>
<li>get_charsets(failobj=None)<br>返回包含消息中字符集名称的列表。如果消息是multipart，则列表将为有效负载中的每个子部分包含一个元素（字符串，表示子部分charset的Content-Type标头中的参数值），否则，它将是长度为1的列表  </li>
<li>is_attachment()<br>Content-Disposition值为attachment时返回True  </li>
<li>get_content_disposition()<br>返回 Content-Disposition 的值，如果没有则None</li>
<li>preamble  </li>
<li>epilogue  </li>
<li>defects  </li>
</ul>
<h3 id="查询和处理消息的内容（有效负载）有关"><a href="#查询和处理消息的内容（有效负载）有关" class="headerlink" title="查询和处理消息的内容（有效负载）有关"></a>查询和处理消息的内容（有效负载）有关</h3><ul>
<li>walk()<br>迭代器。DFS遍历消息对象树在for循环中用作迭代器  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> part <span class="keyword">in</span> msg.walk():</span><br><span class="line"><span class="meta">... </span>    print(part.get_content_type())</span><br><span class="line">multipart/report</span><br><span class="line">text/plain</span><br><span class="line">message/delivery-status</span><br><span class="line">text/plain</span><br><span class="line">text/plain</span><br><span class="line">message/rfc822</span><br><span class="line">text/plain</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>walk会继续访问is_multipart()返回true的对象<br>is_multipart() returns True ,msg.get_content_maintype() == ‘multipart’ may return False (message/xxx)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> email.iterators <span class="keyword">import</span> _structure</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> part <span class="keyword">in</span> msg.walk():</span><br><span class="line"><span class="meta">... </span>    print(part.get_content_maintype() == <span class="string">'multipart'</span>,</span><br><span class="line"><span class="meta">... </span>          part.is_multipart())</span><br><span class="line"><span class="keyword">True</span> <span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">False</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">True</span></span><br><span class="line"><span class="keyword">False</span> <span class="keyword">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>_structure(msg)</span><br><span class="line">multipart/report</span><br><span class="line">    text/plain</span><br><span class="line">    message/delivery-status</span><br><span class="line">        text/plain</span><br><span class="line">        text/plain</span><br><span class="line">    message/rfc822</span><br><span class="line">        text/plain</span><br></pre></td></tr></table></figure></p>
<ul>
<li>get_body(preferencelist=(‘related’, ‘html’, ‘plain’))<br>返回最适合作为邮件“正文”的MIME部分<br>参数是几个被视为正文的优先次序<br>遇到multipart/related时，检查start参数，如果子部分Content-ID匹配，则只考虑该子部分。否则考虑multipart/related的第一部分  </li>
<li>iter_attachments()<br>返回非正文（body）迭代器。跳过的每一个的第一次出现text/plain，text/html，multipart/related，或 multipart/alternative  </li>
<li>iter_parts()<br>返回所有子部分迭代器 非multipart返回空  </li>
<li>get_content(*args, content_manager=None, **kw)<br>调用content_manager的get_content()方法，将self作为消息对象传递，并将其他任何参数或关键字作为附加参数传递。如果 未指定content_manager，则使用policy指定的content_manager  </li>
<li>set_content(*args, content_manager=None, **kw)  </li>
<li>make_related(boundary=None)<br>将非multipart消息转换为multipart/related消息，将所有现有的Content- Header和有效负载移动到的（新）第一部分multipart。如果边界指定，使用它作为在所述多部分的边界的字符串，否则离开边界到在需要时被自动创建（例如，当消息被序列）  </li>
<li>make_alternative(boundary=None)<br>将非multipart或转换multipart/related为a multipart/alternative  </li>
<li>make_mixed(boundary=None)<br>将non multipart，a multipart/related或a multipart-alternative转换为a multipart/mixed  </li>
<li>add_related（* args，content_manager = None，** kw ）<br>如果消息为multipart/related，则创建一个新的消息对象，将所有参数传递给它的set_content()方法，然后attach()传递给multipart。如果该消息不是multipart，调用make_related()之后在进行上述操作  </li>
<li>add_alternative(*args, content_manager=None, **kw)  </li>
<li>add_attachment(*args, content_manager=None, **kw)  </li>
<li>clear()<br>删除有效负载和所有标头  </li>
<li>clear_content()<br>删除有效负载和所有Content-标头，并保留所有其他标头并保持其原始顺序。  </li>
</ul>
<h2 id="email-generator-Generating-MIME-documents"><a href="#email-generator-Generating-MIME-documents" class="headerlink" title="email.generator: Generating MIME documents"></a>email.generator: Generating MIME documents</h2><p>写一个.eml文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> email <span class="keyword">import</span> generator</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line">active_dir = <span class="string">'c:\\'</span></span><br><span class="line"></span><br><span class="line">cwd = os.getcwd()</span><br><span class="line">outfile_name = os.path.join(cwd, <span class="string">'message.eml'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gen_Emails</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.EmailGen()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">EmailGen</span><span class="params">(self)</span>:</span></span><br><span class="line">        sender = <span class="string">'sender'</span></span><br><span class="line">        recepiant = <span class="string">'recipiant'</span></span><br><span class="line">        subject = <span class="string">'subject'</span></span><br><span class="line"></span><br><span class="line">        msg = MIMEMultipart(<span class="string">'alternative'</span>)</span><br><span class="line">        msg[<span class="string">'Subject'</span>] = subject</span><br><span class="line">        msg[<span class="string">'From'</span>] = sender</span><br><span class="line">        msg[<span class="string">'To'</span>] = recepiant</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        html = <span class="string">"""\</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt; hello world &lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        part = MIMEText(html, <span class="string">'html'</span>)</span><br><span class="line"></span><br><span class="line">        msg.attach(part)</span><br><span class="line"></span><br><span class="line">        self.SaveToFile(msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SaveToFile</span><span class="params">(self,msg)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(outfile_name, <span class="string">'w'</span>) <span class="keyword">as</span> outfile:</span><br><span class="line">            gen = generator.Generator(outfile)</span><br><span class="line">            gen.flatten(msg)</span><br></pre></td></tr></table></figure></p>
<h2 id="email-policy-Policy-Objects"><a href="#email-policy-Policy-Objects" class="headerlink" title="email.policy: Policy Objects"></a>email.policy: Policy Objects</h2><p>Policy实例是不可变的，但是可以将其克隆，接受与类构造函数相同的关键字参数，并返回一个新 Policy实例，该实例是原始实例的副本，但指定的属性值已更改  </p>
<h2 id="email-headerregistry"><a href="#email-headerregistry" class="headerlink" title="email.headerregistry"></a>email.headerregistry</h2><h2 id="email-contentmanager"><a href="#email-contentmanager" class="headerlink" title="email.contentmanager"></a>email.contentmanager</h2><p>class email.contentmanager.ContentManager  </p>
<ul>
<li>as_string(unixfrom=False, maxheaderlen=0, policy=None)  </li>
<li>__str__()</li>
<li>as_bytes(unixfrom=False, policy=None)  </li>
<li>__bytes__()  </li>
<li>is_multipart()  </li>
<li>set_unixfrom(unixfrom)  </li>
<li>get_unixfrom()  </li>
<li>attach(payload)<br>EmailMessage中set_content()等同  </li>
<li>get_payload(i=None, decode=False)<br>返回当前二进制/字符串有效负载。可选参数i，将返回有效载荷的第i个元素从0开始 decode是True时，负载不是muiltipart,Content-Transfer-Encoding是quoted-printable 或者 base64，则解码。decode是False时,主体会返回字符串。 EmailMessage中get_content() 和 iter_parts().  </li>
<li>set_payload(payload, charset=None)  </li>
<li>set_charset(charset)  </li>
<li>get_charset()  </li>
<li>__len__()  </li>
<li>__contains\_(name)  </li>
<li>__getitem__(name)</li>
<li>__delitem__(name)  </li>
<li>keys()  </li>
<li>values()  </li>
<li>items()  </li>
<li>get(name, failobj=None)<br>···其他都与EmailMessage相同</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> BytesParser, Parser</span><br><span class="line"><span class="keyword">from</span> email.policy <span class="keyword">import</span> default</span><br><span class="line"></span><br><span class="line"><span class="comment"># If the e-mail headers are in a file, uncomment these two lines:</span></span><br><span class="line"><span class="comment"># with open(messagefile, 'rb') as fp:</span></span><br><span class="line"><span class="comment">#     headers = BytesParser(policy=default).parse(fp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Or for parsing headers in a string (this is an uncommon operation), use:</span></span><br><span class="line">headers = Parser(policy=default).parsestr(</span><br><span class="line">        <span class="string">'From: Foo Bar &lt;user@example.com&gt;\n'</span></span><br><span class="line">        <span class="string">'To: &lt;someone_else@example.com&gt;\n'</span></span><br><span class="line">        <span class="string">'Subject: Test message\n'</span></span><br><span class="line">        <span class="string">'\n'</span></span><br><span class="line">        <span class="string">'Body would go here\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  Now the header items can be accessed as a dictionary:</span></span><br><span class="line">print(<span class="string">'To: &#123;&#125;'</span>.format(headers[<span class="string">'to'</span>]))</span><br><span class="line">print(<span class="string">'From: &#123;&#125;'</span>.format(headers[<span class="string">'from'</span>]))</span><br><span class="line">print(<span class="string">'Subject: &#123;&#125;'</span>.format(headers[<span class="string">'subject'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># You can also access the parts of the addresses:</span></span><br><span class="line">print(<span class="string">'Recipient username: &#123;&#125;'</span>.format(headers[<span class="string">'to'</span>].addresses[<span class="number">0</span>].username))</span><br><span class="line">print(<span class="string">'Sender name: &#123;&#125;'</span>.format(headers[<span class="string">'from'</span>].addresses[<span class="number">0</span>].display_name))</span><br></pre></td></tr></table></figure>
<p>以下是如何发送包含在目录中的一系列家庭照片的MIME消息示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import smtplib for the actual sending function</span></span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"></span><br><span class="line"><span class="comment"># And imghdr to find the types of our images</span></span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"></span><br><span class="line"><span class="comment"># Here are the email package modules we'll need</span></span><br><span class="line"><span class="keyword">from</span> email.message <span class="keyword">import</span> EmailMessage</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the container email message.</span></span><br><span class="line">msg = EmailMessage()</span><br><span class="line">msg[<span class="string">'Subject'</span>] = <span class="string">'Our family reunion'</span></span><br><span class="line"><span class="comment"># me == the sender's email address</span></span><br><span class="line"><span class="comment"># family = the list of all recipients' email addresses</span></span><br><span class="line">msg[<span class="string">'From'</span>] = me</span><br><span class="line">msg[<span class="string">'To'</span>] = <span class="string">', '</span>.join(family)</span><br><span class="line">msg.preamble = <span class="string">'You will not see this in a MIME-aware mail reader.\n'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Open the files in binary mode.  Use imghdr to figure out the</span></span><br><span class="line"><span class="comment"># MIME subtype for each specific image.</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> pngfiles:</span><br><span class="line">    <span class="keyword">with</span> open(file, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        img_data = fp.read()</span><br><span class="line">    msg.add_attachment(img_data, maintype=<span class="string">'image'</span>,</span><br><span class="line">                                 subtype=imghdr.what(<span class="keyword">None</span>, img_data))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send the email via our own SMTP server.</span></span><br><span class="line"><span class="keyword">with</span> smtplib.SMTP(<span class="string">'localhost'</span>) <span class="keyword">as</span> s:</span><br><span class="line">    s.send_message(msg)</span><br></pre></td></tr></table></figure></p>
<p>以下是如何将上述MIME消息解压缩到文件目录中的示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""Unpack a MIME message into a directory of files."""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> email</span><br><span class="line"><span class="keyword">import</span> mimetypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.policy <span class="keyword">import</span> default</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"""\</span></span><br><span class="line"><span class="string">Unpack a MIME message into a directory of files.</span></span><br><span class="line"><span class="string">"""</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-d'</span>, <span class="string">'--directory'</span>, required=<span class="keyword">True</span>,</span><br><span class="line">                        help=<span class="string">"""Unpack the MIME message into the named</span></span><br><span class="line"><span class="string">                        directory, which will be created if it doesn't already</span></span><br><span class="line"><span class="string">                        exist."""</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'msgfile'</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(args.msgfile, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        msg = email.message_from_binary_file(fp, policy=default)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(args.directory)</span><br><span class="line">    <span class="keyword">except</span> FileExistsError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    counter = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> part <span class="keyword">in</span> msg.walk():</span><br><span class="line">        <span class="comment"># multipart/* are just containers</span></span><br><span class="line">        <span class="keyword">if</span> part.get_content_maintype() == <span class="string">'multipart'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># Applications should really sanitize the given filename so that an</span></span><br><span class="line">        <span class="comment"># email message can't be used to overwrite important files</span></span><br><span class="line">        filename = part.get_filename()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> filename:</span><br><span class="line">            ext = mimetypes.guess_extension(part.get_content_type())</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ext:</span><br><span class="line">                <span class="comment"># Use a generic bag-of-bits extension</span></span><br><span class="line">                ext = <span class="string">'.bin'</span></span><br><span class="line">            filename = <span class="string">f'part-<span class="subst">&#123;counter:<span class="number">03</span>d&#125;</span><span class="subst">&#123;ext&#125;</span>'</span></span><br><span class="line">        counter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">with</span> open(os.path.join(args.directory, filename), <span class="string">'wb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">            fp.write(part.get_payload(decode=<span class="keyword">True</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>在HTML中插入图片发送：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.message <span class="keyword">import</span> EmailMessage</span><br><span class="line"><span class="keyword">from</span> email.headerregistry <span class="keyword">import</span> Address</span><br><span class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> make_msgid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the base text message.</span></span><br><span class="line">msg = EmailMessage()</span><br><span class="line">msg[<span class="string">'Subject'</span>] = <span class="string">"Ayons asperges pour le déjeuner"</span></span><br><span class="line">msg[<span class="string">'From'</span>] = Address(<span class="string">"Pepé Le Pew"</span>, <span class="string">"pepe"</span>, <span class="string">"example.com"</span>)</span><br><span class="line">msg[<span class="string">'To'</span>] = (Address(<span class="string">"Penelope Pussycat"</span>, <span class="string">"penelope"</span>, <span class="string">"example.com"</span>),</span><br><span class="line">             Address(<span class="string">"Fabrette Pussycat"</span>, <span class="string">"fabrette"</span>, <span class="string">"example.com"</span>))</span><br><span class="line">msg.set_content(<span class="string">"""\</span></span><br><span class="line"><span class="string">Salut!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Cela ressemble à un excellent recipie[1] déjeuner.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[1] http://www.yummly.com/recipe/Roasted-Asparagus-Epicurious-203718</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--Pepé</span></span><br><span class="line"><span class="string">"""</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the html version.  This converts the message into a multipart/alternative</span></span><br><span class="line"><span class="comment"># container, with the original text message as the first part and the new html</span></span><br><span class="line"><span class="comment"># message as the second part.</span></span><br><span class="line">asparagus_cid = make_msgid() <span class="comment">#生成Message-ID</span></span><br><span class="line">msg.add_alternative(<span class="string">"""\</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">  &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;Salut!&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;Cela ressemble à un excellent</span></span><br><span class="line"><span class="string">        &lt;a href="http://www.yummly.com/recipe/Roasted-Asparagus-Epicurious-203718"&gt;</span></span><br><span class="line"><span class="string">            recipie</span></span><br><span class="line"><span class="string">        &lt;/a&gt; déjeuner.</span></span><br><span class="line"><span class="string">    &lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;img src="cid:&#123;asparagus_cid&#125;" /&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"""</span>.format(asparagus_cid=asparagus_cid[<span class="number">1</span>:<span class="number">-1</span>]), subtype=<span class="string">'html'</span>)</span><br><span class="line"><span class="comment"># note that we needed to peel the &lt;&gt; off the msgid for use in the html.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Now add the related image to the html part.</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"roasted-asparagus.jpg"</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> img:</span><br><span class="line">    msg.get_payload()[<span class="number">1</span>].add_related(img.read(), <span class="string">'image'</span>, <span class="string">'jpeg'</span>,</span><br><span class="line">                                     cid=asparagus_cid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make a local copy of what we are going to send.</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'outgoing.msg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(bytes(msg))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send the message via local SMTP server.</span></span><br><span class="line"><span class="keyword">with</span> smtplib.SMTP(<span class="string">'localhost'</span>) <span class="keyword">as</span> s:</span><br><span class="line">    s.send_message(msg)</span><br></pre></td></tr></table></figure></p>
<p>处理html中带有附件的邮件文件（xx.msg）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> mimetypes</span><br><span class="line"><span class="keyword">import</span> webbrowser</span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the email modules we'll need</span></span><br><span class="line"><span class="keyword">from</span> email <span class="keyword">import</span> policy</span><br><span class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> BytesParser</span><br><span class="line"></span><br><span class="line"><span class="comment"># An imaginary module that would make this work and be safe.</span></span><br><span class="line"><span class="keyword">from</span> imaginary <span class="keyword">import</span> magic_html_parser</span><br><span class="line"></span><br><span class="line"><span class="comment"># In a real program you'd get the filename from the arguments.</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'outgoing.msg'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    msg = BytesParser(policy=policy.default).parse(fp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now the header items can be accessed as a dictionary, and any non-ASCII will</span></span><br><span class="line"><span class="comment"># be converted to unicode:</span></span><br><span class="line">print(<span class="string">'To:'</span>, msg[<span class="string">'to'</span>])</span><br><span class="line">print(<span class="string">'From:'</span>, msg[<span class="string">'from'</span>])</span><br><span class="line">print(<span class="string">'Subject:'</span>, msg[<span class="string">'subject'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># If we want to print a preview of the message content, we can extract whatever</span></span><br><span class="line"><span class="comment"># the least formatted payload is and print the first three lines.  Of course,</span></span><br><span class="line"><span class="comment"># if the message has no plain text part printing the first three lines of html</span></span><br><span class="line"><span class="comment"># is probably useless, but this is just a conceptual example.</span></span><br><span class="line">simplest = msg.get_body(preferencelist=(<span class="string">'plain'</span>, <span class="string">'html'</span>))</span><br><span class="line">print()</span><br><span class="line">print(<span class="string">''</span>.join(simplest.get_content().splitlines(keepends=<span class="keyword">True</span>)[:<span class="number">3</span>]))</span><br><span class="line"></span><br><span class="line">ans = input(<span class="string">"View full message?"</span>)</span><br><span class="line"><span class="keyword">if</span> ans.lower()[<span class="number">0</span>] == <span class="string">'n'</span>:</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># We can extract the richest alternative in order to display it:</span></span><br><span class="line">richest = msg.get_body()</span><br><span class="line">partfiles = &#123;&#125;</span><br><span class="line"><span class="keyword">if</span> richest[<span class="string">'content-type'</span>].maintype == <span class="string">'text'</span>:</span><br><span class="line">    <span class="keyword">if</span> richest[<span class="string">'content-type'</span>].subtype == <span class="string">'plain'</span>:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> richest.get_content().splitlines():</span><br><span class="line">            print(line)</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="keyword">elif</span> richest[<span class="string">'content-type'</span>].subtype == <span class="string">'html'</span>:</span><br><span class="line">        body = richest</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Don't know how to display &#123;&#125;"</span>.format(richest.get_content_type()))</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="keyword">elif</span> richest[<span class="string">'content-type'</span>].content_type == <span class="string">'multipart/related'</span>:</span><br><span class="line">    body = richest.get_body(preferencelist=(<span class="string">'html'</span>))</span><br><span class="line">    <span class="keyword">for</span> part <span class="keyword">in</span> richest.iter_attachments():</span><br><span class="line">        fn = part.get_filename()</span><br><span class="line">        <span class="keyword">if</span> fn:</span><br><span class="line">            extension = os.path.splitext(part.get_filename())[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            extension = mimetypes.guess_extension(part.get_content_type())</span><br><span class="line">        <span class="keyword">with</span> tempfile.NamedTemporaryFile(suffix=extension, delete=<span class="keyword">False</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(part.get_content())</span><br><span class="line">            <span class="comment"># again strip the &lt;&gt; to go from email form of cid to html form.</span></span><br><span class="line">            partfiles[part[<span class="string">'content-id'</span>][<span class="number">1</span>:<span class="number">-1</span>]] = f.name</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">"Don't know how to display &#123;&#125;"</span>.format(richest.get_content_type()))</span><br><span class="line">    sys.exit()</span><br><span class="line"><span class="keyword">with</span> tempfile.NamedTemporaryFile(mode=<span class="string">'w'</span>, delete=<span class="keyword">False</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># The magic_html_parser has to rewrite the href="cid:...." attributes to</span></span><br><span class="line">    <span class="comment"># point to the filenames in partfiles.  It also has to do a safety-sanitize</span></span><br><span class="line">    <span class="comment"># of the html.  It could be written using html.parser.</span></span><br><span class="line">    f.write(magic_html_parser(body.get_content(), partfiles))</span><br><span class="line">webbrowser.open(f.name)</span><br><span class="line">os.remove(f.name)</span><br><span class="line"><span class="keyword">for</span> fn <span class="keyword">in</span> partfiles.values():</span><br><span class="line">    os.remove(fn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Of course, there are lots of email messages that could break this simple</span></span><br><span class="line"><span class="comment"># minded program, but it will handle the most common ones.</span></span><br></pre></td></tr></table></figure></p>
<p>To: Penelope Pussycat <a href="mailto:&#112;&#x65;&#x6e;&#x65;&#x6c;&#111;&#x70;&#x65;&#64;&#101;&#x78;&#x61;&#109;&#x70;&#108;&#x65;&#x2e;&#x63;&#x6f;&#x6d;" target="_blank" rel="noopener">&#112;&#x65;&#x6e;&#x65;&#x6c;&#111;&#x70;&#x65;&#64;&#101;&#x78;&#x61;&#109;&#x70;&#108;&#x65;&#x2e;&#x63;&#x6f;&#x6d;</a>, Fabrette Pussycat <a href="mailto:&#102;&#97;&#98;&#114;&#101;&#116;&#116;&#101;&#x40;&#x65;&#x78;&#97;&#x6d;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;" target="_blank" rel="noopener">&#102;&#97;&#98;&#114;&#101;&#116;&#116;&#101;&#x40;&#x65;&#x78;&#97;&#x6d;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;</a><br>From: Pepé Le Pew <a href="mailto:&#112;&#101;&#112;&#x65;&#x40;&#x65;&#120;&#97;&#x6d;&#x70;&#108;&#x65;&#x2e;&#x63;&#111;&#x6d;" target="_blank" rel="noopener">&#112;&#101;&#112;&#x65;&#x40;&#x65;&#120;&#97;&#x6d;&#x70;&#108;&#x65;&#x2e;&#x63;&#111;&#x6d;</a><br>Subject: Ayons asperges pour le déjeuner</p>
<p>Salut!</p>
<p>Cela ressemble à un excellent recipie[1] déjeuner.</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/ToadYawn">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank"  href="https://www.linkedin.com/in/tingyu-hu">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-linkedin"></i>
                            </span>
            </a>
        </li>
        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.baidu.com">It helps SEO</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
